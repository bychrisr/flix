# Story 3.2: Release-Window Access Enforcement

## Status
Review

## Executor Assignment
executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: ["manual-review"]

## Story
**As a platform owner**,  
**I want server-authoritative release checks for lesson access**,  
**so that learners cannot bypass content gating rules**.

## Acceptance Criteria
1. Access endpoint returns consistent authorization based on release/expiry windows.
2. Locked and expired lessons are blocked from playback route access.
3. User-facing status messaging is returned for blocked scenarios.
4. Private event access rules are validated together with release-window checks.

## Tasks / Subtasks
- [x] Task 1 (AC: 1) Access endpoint returns consistent authorization based on release/expiry windows
  - [x] Implement technical changes required for AC 1
  - [x] Add validation/tests for AC 1
- [x] Task 2 (AC: 2) Locked and expired lessons are blocked from playback route access
  - [x] Implement technical changes required for AC 2
  - [x] Add validation/tests for AC 2
- [x] Task 3 (AC: 3) User-facing status messaging is returned for blocked scenarios
  - [x] Implement technical changes required for AC 3
  - [x] Add validation/tests for AC 3
- [x] Task 4 (AC: 4) Private event access rules are validated together with release-window checks
  - [x] Implement technical changes required for AC 4
  - [x] Add validation/tests for AC 4

## Dev Notes
### Previous Story Insights
- Use previous completed story notes when available. For this planning batch, no implementation carry-over is required.

### Data Models
- Use the domain entities from architecture shards when applicable to this story.
  [Source: docs/architecture/data-models.md#Data Models]

### API Specifications
- Follow REST contracts and endpoint boundaries from API specification shards.
  [Source: docs/architecture/api-specification.md#API Specification]

### File Locations
- Respect monorepo boundaries (`apps/web`, `apps/admin`, `services/api`, `packages/design-system`).
  [Source: docs/architecture/unified-project-structure.md#Unified Project Structure]

### Technical Constraints
- Keep implementation aligned with selected stack and architecture patterns.
  [Source: docs/architecture/tech-stack.md#Tech Stack]
  [Source: docs/architecture/high-level-architecture.md#High Level Architecture]
### Component Specifications
- Follow frontend component and routing architecture for UI stories.
  [Source: docs/architecture/frontend-architecture.md#Frontend Architecture]
  [Source: docs/architecture/components.md#Components]


- Story source: docs/prd/epic-3-learner-experience-core-catalog-and-playback.md

## Testing
- Follow test pyramid and organization from architecture testing strategy.
  [Source: docs/architecture/testing-strategy.md#Testing Strategy]
- Add/update unit tests for new business logic.
- Add/update integration tests for modified API flows when applicable.
- Ensure critical journey impact is considered for E2E smoke coverage.

## ðŸ¤– CodeRabbit Integration

> **CodeRabbit Integration**: Disabled
>
> CodeRabbit CLI is not enabled in `core-config.yaml`.
> Quality validation will use manual review process only.
> To enable, set `coderabbit_integration.enabled: true` in core-config.yaml.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-11 | 1.0 | Story created from 3.2 epic section with architecture context | @sm |
| 2026-02-12 | 1.1 | Release-window and private-access enforcement implemented with integration tests | @dev |

## Dev Agent Record
### Agent Model Used
GPT-5 Codex (CLI)

### Debug Log References
- No dedicated debug log file generated for this story.

### Completion Notes List
- Added server-authoritative learner access service for release, expiry, and private-event checks.
- Added public endpoint `POST /api/public/events/:eventSlug/lessons/:lessonSlug/access-check`.
- Added playback gate endpoint `POST /api/public/events/:eventSlug/lessons/:lessonSlug/playback`.
- Added consistent status and user-facing messages for `released`, `locked`, `expired`, and `blocked_private`.
- Added private-event access key support and validation through event metadata.

### File List
- services/api/src/app.js
- services/api/src/routes/events.js
- services/api/src/routes/public-access.js
- services/api/src/services/event-service.js
- services/api/src/services/lesson-service.js
- services/api/src/services/learner-access-service.js
- services/api/tests/integration/public-access.test.js

## QA Results
- PASS: `npm run test --workspace @flix/api`
- PASS: `npm run test --workspaces --if-present`
