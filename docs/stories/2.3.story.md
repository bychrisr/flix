# Story 2.3: Lesson CRUD with Release Window Rules

## Status
Review

## Executor Assignment
executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: ["manual-review"]

## Story
**As an admin**,  
**I want to schedule lesson release and optional expiration dates**,  
**so that content availability follows launch strategy**.

## Acceptance Criteria
1. Admin can create, update, list, and delete lessons linked to an event.
2. Release datetime is required and expiration datetime is optional.
3. Business validation rejects invalid date windows.

## Tasks / Subtasks
- [x] Task 1 (AC: 1) Admin can create, update, list, and delete lessons linked to an event
  - [x] Implement technical changes required for AC 1
  - [x] Add validation/tests for AC 1
- [x] Task 2 (AC: 2) Release datetime is required and expiration datetime is optional
  - [x] Implement technical changes required for AC 2
  - [x] Add validation/tests for AC 2
- [x] Task 3 (AC: 3) Business validation rejects invalid date windows
  - [x] Implement technical changes required for AC 3
  - [x] Add validation/tests for AC 3

## Dev Notes
### Previous Story Insights
- Use previous completed story notes when available. For this planning batch, no implementation carry-over is required.

### Data Models
- Use the domain entities from architecture shards when applicable to this story.
  [Source: docs/architecture/data-models.md#Data Models]

### API Specifications
- Follow REST contracts and endpoint boundaries from API specification shards.
  [Source: docs/architecture/api-specification.md#API Specification]

### File Locations
- Respect monorepo boundaries (`apps/web`, `apps/admin`, `services/api`, `packages/design-system`).
  [Source: docs/architecture/unified-project-structure.md#Unified Project Structure]

### Technical Constraints
- Keep implementation aligned with selected stack and architecture patterns.
  [Source: docs/architecture/tech-stack.md#Tech Stack]
  [Source: docs/architecture/high-level-architecture.md#High Level Architecture]
### Component Specifications
- Follow frontend component and routing architecture for UI stories.
  [Source: docs/architecture/frontend-architecture.md#Frontend Architecture]
  [Source: docs/architecture/components.md#Components]


- Story source: docs/prd/epic-2-admin-content-operations-events-and-lessons.md

## Testing
- Follow test pyramid and organization from architecture testing strategy.
  [Source: docs/architecture/testing-strategy.md#Testing Strategy]
- Add/update unit tests for new business logic.
- Add/update integration tests for modified API flows when applicable.
- Ensure critical journey impact is considered for E2E smoke coverage.

## ðŸ¤– CodeRabbit Integration

> **CodeRabbit Integration**: Disabled
>
> CodeRabbit CLI is not enabled in `core-config.yaml`.
> Quality validation will use manual review process only.
> To enable, set `coderabbit_integration.enabled: true` in core-config.yaml.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-11 | 1.0 | Story created from 2.3 epic section with architecture context | @sm |
| 2026-02-12 | 1.1 | Lesson CRUD and release window rules implemented with integration coverage | @dev |

## Dev Agent Record
### Agent Model Used
GPT-5 Codex (CLI)

### Debug Log References
- No dedicated debug log file generated for this story.

### Completion Notes List
- Added admin-protected lesson CRUD endpoints scoped by event id.
- Added lesson domain service with event linkage checks.
- Implemented required `releaseAt` and optional `expiresAt` semantics.
- Added business rule to reject expiration datetime earlier than or equal to release datetime.
- Added integration tests for full lesson lifecycle and invalid date-window rejection.

### File List
- services/api/src/app.js
- services/api/src/routes/events.js
- services/api/src/routes/lessons.js
- services/api/src/services/event-service.js
- services/api/src/services/lesson-service.js
- services/api/tests/integration/lessons-crud.test.js

## QA Results
- PASS: `npm run test --workspace @flix/api`
- PASS: `npm run test --workspaces --if-present`
