# Story 3.4: Release Countdown and Status Clarity

## Status
Review

## Executor Assignment
executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: ["manual-review"]

## Story
**As a learner**,  
**I want clear countdown/status cues for upcoming lessons**,  
**so that I know when content will unlock**.

## Acceptance Criteria
1. Countdown UI appears when lesson is not yet released.
2. Countdown is derived from server timestamps to avoid client drift issues.
3. Status transitions are reflected correctly after release time.

## Tasks / Subtasks
- [x] Task 1 (AC: 1) Countdown UI appears when lesson is not yet released
  - [x] Implement technical changes required for AC 1
  - [x] Add validation/tests for AC 1
- [x] Task 2 (AC: 2) Countdown is derived from server timestamps to avoid client drift issues
  - [x] Implement technical changes required for AC 2
  - [x] Add validation/tests for AC 2
- [x] Task 3 (AC: 3) Status transitions are reflected correctly after release time
  - [x] Implement technical changes required for AC 3
  - [x] Add validation/tests for AC 3

## Dev Notes
### Previous Story Insights
- Use previous completed story notes when available. For this planning batch, no implementation carry-over is required.

### Data Models
- Use the domain entities from architecture shards when applicable to this story.
  [Source: docs/architecture/data-models.md#Data Models]

### API Specifications
- Follow REST contracts and endpoint boundaries from API specification shards.
  [Source: docs/architecture/api-specification.md#API Specification]

### File Locations
- Respect monorepo boundaries (`apps/web`, `apps/admin`, `services/api`, `packages/design-system`).
  [Source: docs/architecture/unified-project-structure.md#Unified Project Structure]

### Technical Constraints
- Keep implementation aligned with selected stack and architecture patterns.
  [Source: docs/architecture/tech-stack.md#Tech Stack]
  [Source: docs/architecture/high-level-architecture.md#High Level Architecture]
### Component Specifications
- Follow frontend component and routing architecture for UI stories.
  [Source: docs/architecture/frontend-architecture.md#Frontend Architecture]
  [Source: docs/architecture/components.md#Components]


- Story source: docs/prd/epic-3-learner-experience-core-catalog-and-playback.md

## Testing
- Follow test pyramid and organization from architecture testing strategy.
  [Source: docs/architecture/testing-strategy.md#Testing Strategy]
- Add/update unit tests for new business logic.
- Add/update integration tests for modified API flows when applicable.
- Ensure critical journey impact is considered for E2E smoke coverage.

## ðŸ¤– CodeRabbit Integration

> **CodeRabbit Integration**: Disabled
>
> CodeRabbit CLI is not enabled in `core-config.yaml`.
> Quality validation will use manual review process only.
> To enable, set `coderabbit_integration.enabled: true` in core-config.yaml.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-11 | 1.0 | Story created from 3.4 epic section with architecture context | @sm |
| 2026-02-12 | 1.1 | Server-driven countdown metadata added to access-check contract with status transition coverage | @dev |

## Dev Agent Record
### Agent Model Used
GPT-5 Codex (CLI)

### Debug Log References
- No dedicated debug log file generated for this story.

### Completion Notes List
- Added server-derived countdown metadata to lesson access-check responses.
- Access-check now returns `timing` with `serverTime`, `releaseAt`, `expiresAt`, and `unlocksInSeconds`.
- Countdown values are generated on backend using a single server timestamp source to prevent client clock drift.
- Confirmed status transition semantics through tests: locked lessons expose positive countdown; released/expired expose zero.
- Maintained compatibility with existing public access/private access checks.

### File List
- services/api/src/routes/public-access.js
- services/api/src/services/lesson-service.js
- services/api/tests/integration/public-access.test.js

## QA Results
- PASS: `npm run test --workspace @flix/api`
- PASS: `npm run test --workspaces --if-present`
