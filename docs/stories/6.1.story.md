# Story 6.1: Database Schema, Migrations, and Seed Baseline

## Status
Done

## Executor Assignment
executor: "@data-engineer"
quality_gate: "@dev"
quality_gate_tools: ["manual-review"]

## Story
**As a** platform engineer,  
**I want** a reproducible database schema and seed process,  
**so that** local and shared environments start from a consistent persistent state.

## Acceptance Criteria
1. Database schema for events, lessons, materials, quizzes, and auth context is defined and versioned.
2. Migration commands can apply schema changes deterministically in a clean environment.
3. Seed process provides minimum runnable data set for admin and learner journeys.

## Tasks / Subtasks
- [x] Task 1 (AC: 1) Database schema for events, lessons, materials, quizzes, and auth context is defined and versioned.
  - [x] Implement technical changes required for AC 1
  - [x] Add validation/tests for AC 1
- [x] Task 2 (AC: 2) Migration commands can apply schema changes deterministically in a clean environment.
  - [x] Implement technical changes required for AC 2
  - [x] Add validation/tests for AC 2
- [x] Task 3 (AC: 3) Seed process provides minimum runnable data set for admin and learner journeys.
  - [x] Implement technical changes required for AC 3
  - [x] Add validation/tests for AC 3

## Dev Notes
### Previous Story Insights
- Use previous completed story notes when available.

### Data Models
- Use the domain entities from architecture shards when applicable to this story.
  [Source: docs/architecture/data-models.md#Data Models]

### API Specifications
- Follow REST contracts and endpoint boundaries from API specification shards.
  [Source: docs/architecture/api-specification.md#API Specification]

### File Locations
- Respect monorepo boundaries (`apps/web`, `apps/admin`, `services/api`, `packages/design-system`).
  [Source: docs/architecture/unified-project-structure.md#Unified Project Structure]

### Technical Constraints
- Keep implementation aligned with selected stack and architecture patterns.
  [Source: docs/architecture/tech-stack.md#Tech Stack]
  [Source: docs/architecture/high-level-architecture.md#High Level Architecture]

### Service Specifications
- Follow backend module organization and auth/security middleware patterns.
  [Source: docs/architecture/backend-architecture.md#Backend Architecture]
  [Source: docs/architecture/security-and-performance.md#Security and Performance]

- Story source: docs/prd/epic-6-production-runtime-enablement.md

## Testing
- Follow test pyramid and organization from architecture testing strategy.
  [Source: docs/architecture/testing-strategy.md#Testing Strategy]
- Add/update unit tests for new business logic.
- Add/update integration tests for modified API flows when applicable.
- Ensure critical journey impact is considered for E2E smoke coverage.

## ðŸ¤– CodeRabbit Integration

> **CodeRabbit Integration**: Disabled
>
> CodeRabbit CLI is not enabled in `core-config.yaml`.
> Quality validation will use manual review process only.
> To enable, set `coderabbit_integration.enabled: true` in core-config.yaml.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-12 | 1.0 | Story created from epic section with architecture context | @sm |
| 2026-02-12 | 1.1 | Added versioned SQL migration baseline, deterministic seed flow, db scripts, and integration coverage | @dev |

## Dev Agent Record
### Agent Model Used
GPT-5 Codex (CLI)

### Debug Log References
- No dedicated debug log file generated for this story.

### Completion Notes List
- Added initial SQL schema migration for admins, events, lessons, materials, quizzes, quiz questions, and quiz options.
- Added migration runner with checksum-based migration history in `schema_migrations`.
- Added deterministic seed runner with minimum admin + learner runnable dataset.
- Added API workspace scripts for `db:migrate`, `db:seed`, `db:reset`, and `db:verify`.
- Added integration test to validate migration idempotency and seed reproducibility.

### File List
- .gitignore
- services/api/db/README.md
- services/api/db/migrations/001_initial_schema.sql
- services/api/package.json
- services/api/scripts/db-migrate.mjs
- services/api/scripts/db-reset.mjs
- services/api/scripts/db-seed.mjs
- services/api/scripts/db-verify.mjs
- services/api/src/README.md
- services/api/src/config/env.js
- services/api/src/db/client.js
- services/api/src/db/migrate.js
- services/api/src/db/seed.js
- services/api/tests/integration/db-bootstrap.test.js

## QA Results
- PASS: `npm run db:reset --workspace @flix/api`
- PASS: `npm run db:verify --workspace @flix/api`
- PASS: `npm run test --workspace @flix/api`
