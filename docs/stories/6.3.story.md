# Story 6.3: API Adapter Switch to Persistent Storage

## Status
Done

## Executor Assignment
executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: ["manual-review"]

## Story
**As a** delivery team,  
**I want** the API runtime to persist all write/read operations,  
**so that** application data survives server restarts and supports real usage.

## Acceptance Criteria
1. Create/update/delete flows write to persistent storage for all core domains.
2. Public and admin read endpoints return data from persistent storage consistently.
3. Runtime configuration supports local and managed database profiles via environment variables.

## Tasks / Subtasks
- [x] Task 1 (AC: 1) Create/update/delete flows write to persistent storage for all core domains.
  - [x] Implement technical changes required for AC 1
  - [x] Add validation/tests for AC 1
- [x] Task 2 (AC: 2) Public and admin read endpoints return data from persistent storage consistently.
  - [x] Implement technical changes required for AC 2
  - [x] Add validation/tests for AC 2
- [x] Task 3 (AC: 3) Runtime configuration supports local and managed database profiles via environment variables.
  - [x] Implement technical changes required for AC 3
  - [x] Add validation/tests for AC 3

## Dev Notes
### Previous Story Insights
- Use previous completed story notes when available.

### Data Models
- Use the domain entities from architecture shards when applicable to this story.
  [Source: docs/architecture/data-models.md#Data Models]

### API Specifications
- Follow REST contracts and endpoint boundaries from API specification shards.
  [Source: docs/architecture/api-specification.md#API Specification]

### File Locations
- Respect monorepo boundaries (`apps/web`, `apps/admin`, `services/api`, `packages/design-system`).
  [Source: docs/architecture/unified-project-structure.md#Unified Project Structure]

### Technical Constraints
- Keep implementation aligned with selected stack and architecture patterns.
  [Source: docs/architecture/tech-stack.md#Tech Stack]
  [Source: docs/architecture/high-level-architecture.md#High Level Architecture]

### Service Specifications
- Follow backend module organization and auth/security middleware patterns.
  [Source: docs/architecture/backend-architecture.md#Backend Architecture]
  [Source: docs/architecture/security-and-performance.md#Security and Performance]

- Story source: docs/prd/epic-6-production-runtime-enablement.md

## Testing
- Follow test pyramid and organization from architecture testing strategy.
  [Source: docs/architecture/testing-strategy.md#Testing Strategy]
- Add/update unit tests for new business logic.
- Add/update integration tests for modified API flows when applicable.
- Ensure critical journey impact is considered for E2E smoke coverage.

## ðŸ¤– CodeRabbit Integration

> **CodeRabbit Integration**: Disabled
>
> CodeRabbit CLI is not enabled in `core-config.yaml`.
> Quality validation will use manual review process only.
> To enable, set `coderabbit_integration.enabled: true` in core-config.yaml.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-12 | 1.0 | Story created from epic section with architecture context | @sm |
| 2026-02-12 | 1.1 | Added SQLite persistent repositories, runtime adapter selection, and persistence restart coverage | @dev |

## Dev Agent Record
### Agent Model Used
GPT-5 Codex (CLI)

### Debug Log References
- No dedicated debug log file generated for this story.

### Completion Notes List
- Added SQLite repository implementations for events, lessons, materials, and quizzes.
- Added repository factory to switch adapters (`memory` / `sqlite`) based on runtime configuration.
- Updated app bootstrap to select persistence adapter and DB profile via environment variables.
- Added integration coverage to verify that writes persist across app restarts when using SQLite adapter.
- Kept existing API contracts stable while switching default non-test runtime to persistent adapter.

### File List
- docs/stories/6.3.story.md
- services/api/src/app.js
- services/api/src/config/env.js
- services/api/src/repositories/index.js
- services/api/src/repositories/sqlite/index.js
- services/api/src/repositories/sqlite/event-repository.js
- services/api/src/repositories/sqlite/lesson-repository.js
- services/api/src/repositories/sqlite/material-repository.js
- services/api/src/repositories/sqlite/quiz-repository.js
- services/api/src/README.md
- services/api/tests/integration/persistent-runtime.test.js

## QA Results
- PASS: `npm run test --workspace @flix/api`
- PASS: `npm run db:reset --workspace @flix/api`
- PASS: `npm run db:verify --workspace @flix/api`
